name: Cypress E2E

on:
  push:
    branches:
      - 'master'

jobs:
  tests:
    name: Spec split ${{ matrix.split_label }}/3
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - split_label: 1
            split_index: 0
          - split_label: 2
            split_index: 1
          - split_label: 3
            split_index: 2
    env:
      SPLIT: 3
      SPLIT_INDEX: ${{ matrix.split_index }}
      CYPRESS_CACHE_FOLDER: ~/.cache/Cypress
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Contexto inicial
        run: |
          echo "=== CONTEXTO INICIAL JOB SPLIT ${SPLIT_INDEX} ==="
          pwd
          echo "Conteúdo do diretório:"
          ls -R

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.11.1
          cache: npm

      - name: Ajustar versão do npm
        run: npm install -g npm@11.6.3

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress split
        id: cypress_run
        continue-on-error: true
        run: |
          echo "Limpando reports/html e cypress/screenshots antes da execução..."
          rm -rf reports/html || true
          rm -rf cypress/screenshots || true
          npx cypress run

      - name: Auditoria pós-Cypress
        if: ${{ always() }}
        run: |
          echo "=== LISTANDO reports/html ==="
          if [ -d reports/html ]; then
            ls -R reports/html || true
            echo "Arquivos JSON encontrados:"
            find reports/html -name "*.json" -maxdepth 3 || true
          else
            echo "Diretório reports/html NÃO existe"
          fi
          echo "=== LISTANDO cypress/screenshots ==="
          if [ -d cypress/screenshots ]; then
            ls -R cypress/screenshots || true
          else
            echo "Diretório cypress/screenshots NÃO existe"
          fi

      - name: Preparar artefatos brutos
        if: ${{ always() }}
        run: |
          JOB_DIR="artifacts/job-${{ matrix.split_index }}"
          echo "JOB_DIR: $JOB_DIR"
          mkdir -p "$JOB_DIR/reports-html/.jsons"
          mkdir -p "$JOB_DIR/screenshots"

          echo "=== VERIFICANDO ORIGEM DOS JSONs ==="
          if [ -d reports/html/.jsons ]; then
            echo "Diretório reports/html/.jsons existe"
            echo "Conteúdo de reports/html/.jsons:"
            ls -la reports/html/.jsons || true
            echo "Arquivos JSON encontrados na origem:"
            find reports/html/.jsons -name "*.json" -type f || true
            
            echo "=== COPIANDO JSONs ==="
            for json_file in reports/html/.jsons/*.json; do
              if [ -f "$json_file" ]; then
                echo "Copiando: $json_file -> $JOB_DIR/reports-html/.jsons/$(basename "$json_file")"
                cp "$json_file" "$JOB_DIR/reports-html/.jsons/$(basename "$json_file")"
              fi
            done
          else
            echo "ERRO: Diretório reports/html/.jsons NÃO existe!"
          fi

          echo "=== VERIFICANDO ORIGEM DOS SCREENSHOTS ==="
          if [ -d cypress/screenshots ]; then
            echo "Diretório cypress/screenshots existe"
            echo "Copiando screenshots..."
            cp -R cypress/screenshots/* "$JOB_DIR/screenshots/" 2>/dev/null || true
          else
            echo "Diretório cypress/screenshots NÃO existe (normal se não houver falhas)"
          fi

          echo "=== VERIFICAÇÃO FINAL DOS ARQUIVOS COPIADOS ==="
          echo "Conteúdo de $JOB_DIR/reports-html/.jsons após cópia:"
          ls -la "$JOB_DIR/reports-html/.jsons" || true
          echo "JSONs encontrados no destino:"
          find "$JOB_DIR/reports-html/.jsons" -name "*.json" -type f || true
          echo "Estrutura completa de $JOB_DIR:"
          find "$JOB_DIR" -type f || true

      - name: Upload parcial
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: cypress-part-${{ matrix.split_index }}
          path: artifacts/job-${{ matrix.split_index }}
          if-no-files-found: warn
          include-hidden-files: true

  reports:
    name: Consolidar relatórios
    needs: tests
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Contexto inicial consolidação
        run: |
          echo "=== CONTEXTO INICIAL CONSOLIDAÇÃO ==="
          pwd
          echo "Conteúdo do diretório:"
          ls -R

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.11.1
          cache: npm

      - name: Ajustar versão do npm
        run: npm install -g npm@11.6.3

      - name: Install dependencies
        run: npm ci

      - name: Baixar artefatos
        uses: actions/download-artifact@v4
        with:
          path: downloaded

      - name: Auditoria artefatos baixados
        run: |
          echo "=== LISTANDO downloaded ==="
          ls -R downloaded || true
          echo "Arquivos JSON de cada parte:"
          find downloaded -name "*.json" || true

      - name: Organizar arquivos do mochawesome
        run: |
          rm -rf reports/html
          mkdir -p reports/html/.jsons
          mkdir -p cypress/screenshots

          echo "=== PROCESSANDO CADA PARTE BAIXADA ==="
          for part in downloaded/cypress-part-*; do
            if [ -d "$part" ]; then
              echo "Processando: $part"
              
              if [ -d "$part/reports-html/.jsons" ]; then
                echo "  Diretório $part/reports-html/.jsons existe"
                echo "  Conteúdo:"
                ls -la "$part/reports-html/.jsons" || true
                
                echo "  Copiando JSONs de $part/reports-html/.jsons para reports/html/.jsons"
                for json_file in "$part/reports-html/.jsons"/*.json; do
                  if [ -f "$json_file" ]; then
                    filename=$(basename "$json_file")
                    echo "    Copiando: $filename"
                    cp "$json_file" "reports/html/.jsons/$filename"
                  fi
                done
              else
                echo "  AVISO: $part/reports-html/.jsons não existe"
              fi
              
              if [ -d "$part/screenshots" ]; then
                echo "  Copiando screenshots de $part/screenshots"
                cp -R "$part/screenshots"/* cypress/screenshots/ 2>/dev/null || true
              fi
            fi
          done

          echo "=== VERIFICAÇÃO FINAL DOS JSONs CONSOLIDADOS ==="
          echo "Conteúdo de reports/html/.jsons:"
          ls -la reports/html/.jsons || true
          echo "Total de JSONs encontrados:"
          find reports/html/.jsons -name "*.json" -type f | wc -l || echo "0"
          echo "Lista completa de JSONs:"
          find reports/html/.jsons -name "*.json" -type f || true

      - name: Gerar relatório consolidado
        run: |
          echo "JSONs presentes antes do merge:"
          find reports/html/.jsons -name "*.json" || true
          npm run merge-reports
          npm run fix-reports
          npm run generate-report
          echo "=== ESTRUTURA FINAL DE REPORTS/HTML ==="
          ls -R reports/html || true
          echo "Arquivos HTML gerados:"
          find reports/html -maxdepth 2 -name "*.html" || true

      - name: Upload relatório final
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: cypress-report-html
          path: reports/html
          if-no-files-found: error
          include-hidden-files: true
